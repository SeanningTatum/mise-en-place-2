---
description: Creating or modifying custom error classes
globs:
  - "app/models/errors/*.ts"
  - "src/errors/*.ts"
alwaysApply: false
---

# Custom Error Classes

## Overview
Custom error classes provide consistent error handling across repositories and services.

## Base Error Class Pattern

```typescript
export class DomainError extends Error {
  constructor(
    message: string,
    public readonly code: string,
    public readonly statusCode: number = 500,
    public readonly context?: Record<string, unknown>
  ) {
    super(message);
    this.name = "DomainError";
    Object.setPrototypeOf(this, DomainError.prototype);
  }
}
```

## Derived Error Pattern

```typescript
export class NotFoundError extends RepositoryError {
  constructor(
    public readonly entity: string,
    public readonly identifier: string | Record<string, unknown>,
    message?: string
  ) {
    const defaultMessage =
      typeof identifier === "string"
        ? `${entity} not found: ${identifier}`
        : `${entity} not found`;
    super(message || defaultMessage, "NOT_FOUND", 404, {
      entity,
      identifier,
    });
    this.name = "NotFoundError";
    Object.setPrototypeOf(this, NotFoundError.prototype);
  }
}
```

## Common Repository Errors

```typescript
// Base
export class RepositoryError extends Error { ... }

// Specific errors
export class NotFoundError extends RepositoryError { ... }      // 404
export class CreationError extends RepositoryError { ... }      // 500
export class UpdateError extends RepositoryError { ... }        // 500
export class DeletionError extends RepositoryError { ... }      // 500
export class QueryError extends RepositoryError { ... }         // 500
export class ValidationError extends RepositoryError { ... }    // 400
```

## Usage in Repositories

```typescript
import { NotFoundError, UpdateError } from "@/models/errors";

export async function getById(db: Database, id: string) {
  try {
    const result = await db.select().from(table).where(eq(table.id, id));

    if (result.length === 0) {
      throw new NotFoundError("entity", id);
    }

    return result[0];
  } catch (error) {
    if (error instanceof NotFoundError) throw error;
    throw new QueryError("entity", "Failed to retrieve", error);
  }
}
```

## Error Codes Convention

- `NOT_FOUND` - Resource doesn't exist (404)
- `CREATION_FAILED` - Insert failed (500)
- `UPDATE_FAILED` - Update failed (500)
- `DELETION_FAILED` - Delete failed (500)
- `VALIDATION_FAILED` - Business rule violation (400)

## Important

- Always use `Object.setPrototypeOf` for proper `instanceof` checks
- Preserve original errors for debugging
- Re-throw custom errors, wrap unexpected ones
