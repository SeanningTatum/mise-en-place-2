---
description: Accessing environment variables and external services in Cloudflare Workers
globs:
  - app/trpc/**/*.ts
  - workers/**/*.ts
alwaysApply: false
---

# Environment Variables in Cloudflare Workers

**NEVER use `process.env` to access environment variables.** This project runs on Cloudflare Workers where environment variables must be accessed through the Cloudflare `Env` bindings.

## Preferred Pattern: Create Client Instances in Context

For external services (APIs, SDKs), create client instances in the tRPC context and pass them through:

```typescript
// app/trpc/index.ts - Create clients once in context
import { createGeminiClient } from "@/lib/gemini";

export const createTRPCContext = async (opts) => {
  // Create client instance if API key is configured
  const gemini = opts.cfContext.GEMINI_API_KEY
    ? createGeminiClient(opts.cfContext.GEMINI_API_KEY)
    : null;

  return {
    db,
    auth,
    gemini,  // Pass the client instance, not the key
  };
};

// In tRPC routes - use the client instance
export const myRouter = createTRPCRouter({
  myProcedure: protectedProcedure.mutation(async ({ ctx }) => {
    if (!ctx.gemini) {
      throw new TRPCError({ code: "INTERNAL_SERVER_ERROR", message: "Gemini not configured" });
    }
    await ctx.gemini.generateContent(prompt); // âœ… Use the instance
  }),
});
```

## Adding New External Services

1. Add the API key to `.env` for local development
2. Run `bunx wrangler types` to regenerate `worker-configuration.d.ts`
3. Create a client factory function in `app/lib/` (e.g., `createMyServiceClient`)
4. Initialize the client in `createTRPCContext` and add to context
5. For production, set secrets via `wrangler secret put VARIABLE_NAME`

## Where Clients are Created

Client instances are created in two places to be available throughout the app:

### 1. tRPC Context (`app/trpc/index.ts`)
For use in tRPC routes via `ctx`:

```typescript
const gemini = opts.cfContext.GEMINI_API_KEY
  ? createGeminiClient(opts.cfContext.GEMINI_API_KEY)
  : null;
```

### 2. Workers Entry (`workers/app.ts`)
For use in React Router loaders/actions via `context`:

```typescript
const gemini = env.GEMINI_API_KEY
  ? createGeminiClient(env.GEMINI_API_KEY)
  : null;

return requestHandler(request, {
  cloudflare: { env, ctx },
  trpc: trpcCaller,
  auth,
  gemini,  // Available as context.gemini in loaders
});
```

## Current Available Clients

### In tRPC Routes (`ctx.`)
- `ctx.db` - Drizzle database instance
- `ctx.auth` - Better Auth session/user
- `ctx.gemini` - Google Gemini AI client (nullable)

### In React Router Loaders (`context.`)
- `context.trpc` - tRPC caller for server-side API calls
- `context.auth` - Better Auth instance
- `context.gemini` - Google Gemini AI client (nullable)
- `context.cloudflare.env` - Raw env (avoid using directly)
